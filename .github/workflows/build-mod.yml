name: Build Telegram iOS Mod

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  RLOTTIE_REPO: TelegramMessenger/rlottie
  TGCALLS_REPO: TelegramMessenger/tgcalls

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 1

      - name: Initialize submodules
        run: |
          set +e
          
          # Parallel clone all repos
          mkdir -p build-system/bazel-rules third-party/td third-party/webrtc third-party/libvpx third-party/dav1d third-party/XcodeGen
          mkdir -p submodules/rlottie submodules/TgVoipWebrtc submodules/LottieCpp
          
          (git clone --depth 1 https://github.com/bazelbuild/rules_swift.git build-system/bazel-rules/rules_swift 2>/dev/null || true) &
          (git clone --depth 1 https://github.com/ali-fareed/rules_apple.git build-system/bazel-rules/rules_apple 2>/dev/null || true) &
          (git clone --depth 1 https://github.com/bazelbuild/apple_support.git build-system/bazel-rules/apple_support 2>/dev/null || true) &
          (git clone --depth 1 https://github.com/MobileNativeFoundation/rules_xcodeproj.git build-system/bazel-rules/rules_xcodeproj 2>/dev/null || true) &
          (git clone --depth 1 "https://github.com/$RLOTTIE_REPO.git" submodules/rlottie/rlottie || true) &
          (git clone --depth 1 https://github.com/ali-fareed/lottiecpp.git submodules/LottieCpp/lottiecpp || true) &
          (git clone --depth 1 "https://github.com/$TGCALLS_REPO.git" submodules/TgVoipWebrtc/tgcalls || true) &
          (git clone --depth 1 https://github.com/tdlib/td.git third-party/td/td || true) &
          (git clone --depth 1 --branch v1.13.1 https://github.com/webmproject/libvpx.git third-party/libvpx/libvpx || true) &
          (git clone --depth 1 https://github.com/ali-fareed/dav1d.git third-party/dav1d/dav1d || true) &
          (git clone --depth 1 https://github.com/yonaskolb/XcodeGen.git third-party/XcodeGen || true) &
          (git clone --depth 1 https://github.com/ali-fareed/webrtc.git third-party/webrtc/webrtc || true) &
          
          wait
          
          mkdir -p build-system/bazel-rules/sourcekit-bazel-bsp
          echo 'module(name = "sourcekit_bazel_bsp", version = "0.0.1")' > build-system/bazel-rules/sourcekit-bazel-bsp/MODULE.bazel
          echo '# Empty' > build-system/bazel-rules/sourcekit-bazel-bsp/BUILD
          
          # Patch WebRTC for FFmpeg 7.x compatibility (reordered_opaque was removed)
          if [ -f "third-party/webrtc/webrtc/modules/video_coding/codecs/h264/h264_decoder_impl.cc" ]; then
            echo "Patching WebRTC h264_decoder_impl.cc for FFmpeg 7.x..."
            sed -i '' 's/av_frame->reordered_opaque = context->reordered_opaque;/\/\/ FFmpeg 7.x: reordered_opaque removed, use opaque instead\n  av_frame->opaque = context->opaque;/g' third-party/webrtc/webrtc/modules/video_coding/codecs/h264/h264_decoder_impl.cc
            sed -i '' 's/av_context_->reordered_opaque = frame_timestamp_us;/av_context_->opaque = (void*)frame_timestamp_us;/g' third-party/webrtc/webrtc/modules/video_coding/codecs/h264/h264_decoder_impl.cc
            sed -i '' 's/av_frame_->reordered_opaque/(int64_t)av_frame_->opaque/g' third-party/webrtc/webrtc/modules/video_coding/codecs/h264/h264_decoder_impl.cc
            echo "WebRTC patch applied"
          fi
          
          echo "=== rlottie contents ==="
          ls -la submodules/rlottie/rlottie/ || echo "rlottie empty"
          
          # Patch rules_apple to allow building without provisioning profiles
          PROV_FILE="build-system/bazel-rules/rules_apple/apple/internal/partials/provisioning_profile.bzl"
          if [ -f "$PROV_FILE" ]; then
            echo "Patching rules_apple provisioning_profile.bzl..."
            # Replace the fail() call with a pass (return empty partial result)
            sed -i '' 's/fail("ERROR: In @@{label_name}:\\nBuilding for device, but no provisioning_profile attribute was set."\.format(label_name = str(ctx\.label)))/return struct(files = depset(), providers = [])  # Patched: skip provisioning check/g' "$PROV_FILE"
            echo "=== Patched file content (lines 35-50) ==="
            sed -n '35,50p' "$PROV_FILE"
          fi

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Install Bazel and dependencies
        run: |
          brew install bazelisk pkg-config yasm nasm
          bazel --version
          pkg-config --version
          
      - name: Clean Bazel cache
        run: |
          bazel clean --expunge || true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Create build configuration
        run: |
          mkdir -p build-input/configuration-repository/provisioning
          
          echo 'telegram_bazel_path = ""' > build-input/configuration-repository/variables.bzl
          echo 'telegram_bundle_id = "org.telegram.Telegram-iOS-Mod"' >> build-input/configuration-repository/variables.bzl
          echo 'telegram_api_id = "0"' >> build-input/configuration-repository/variables.bzl
          echo 'telegram_api_hash = ""' >> build-input/configuration-repository/variables.bzl
          echo 'telegram_team_id = "ABCDE12345"' >> build-input/configuration-repository/variables.bzl
          echo 'telegram_app_center_id = ""' >> build-input/configuration-repository/variables.bzl
          echo 'telegram_is_internal_build = "false"' >> build-input/configuration-repository/variables.bzl
          echo 'telegram_is_appstore_build = "false"' >> build-input/configuration-repository/variables.bzl
          echo 'telegram_appstore_id = "0"' >> build-input/configuration-repository/variables.bzl
          echo 'telegram_app_specific_url_scheme = "tgmod"' >> build-input/configuration-repository/variables.bzl
          echo 'telegram_premium_iap_product_id = ""' >> build-input/configuration-repository/variables.bzl
          echo 'telegram_aps_environment = "development"' >> build-input/configuration-repository/variables.bzl
          echo 'telegram_enable_siri = "false"' >> build-input/configuration-repository/variables.bzl
          echo 'telegram_enable_icloud = "false"' >> build-input/configuration-repository/variables.bzl
          echo 'telegram_use_xcode_managed_codesigning = False' >> build-input/configuration-repository/variables.bzl
          
          touch build-input/configuration-repository/WORKSPACE
          echo 'module(name = "build_configuration")' > build-input/configuration-repository/MODULE.bazel
          touch build-input/configuration-repository/BUILD
          
          for p in Telegram NotificationContent NotificationService Share Widget WatchApp WatchExtension Intents BroadcastUpload; do
            touch "build-input/configuration-repository/provisioning/${p}.mobileprovision"
          done
          
          echo 'exports_files([' > build-input/configuration-repository/provisioning/BUILD
          echo '    "Telegram.mobileprovision",' >> build-input/configuration-repository/provisioning/BUILD
          echo '    "NotificationContent.mobileprovision",' >> build-input/configuration-repository/provisioning/BUILD
          echo '    "NotificationService.mobileprovision",' >> build-input/configuration-repository/provisioning/BUILD
          echo '    "Share.mobileprovision",' >> build-input/configuration-repository/provisioning/BUILD
          echo '    "Widget.mobileprovision",' >> build-input/configuration-repository/provisioning/BUILD
          echo '    "WatchApp.mobileprovision",' >> build-input/configuration-repository/provisioning/BUILD
          echo '    "WatchExtension.mobileprovision",' >> build-input/configuration-repository/provisioning/BUILD
          echo '    "Intents.mobileprovision",' >> build-input/configuration-repository/provisioning/BUILD
          echo '    "BroadcastUpload.mobileprovision",' >> build-input/configuration-repository/provisioning/BUILD
          echo '])' >> build-input/configuration-repository/provisioning/BUILD

      - name: Cache Bazel
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/bazelisk
          key: bazel-${{ runner.os }}-${{ hashFiles('MODULE.bazel', 'WORKSPACE', 'BUILD.bazel') }}-v2
          restore-keys: |
            bazel-${{ runner.os }}-

      - name: Create configuration JSON
        run: |
          echo '{' > build-configuration.json
          echo '  "bundle_id": "org.telegram.Telegram-iOS-Mod",' >> build-configuration.json
          echo '  "api_id": "0",' >> build-configuration.json
          echo '  "api_hash": "",' >> build-configuration.json
          echo '  "team_id": "ABCDE12345",' >> build-configuration.json
          echo '  "app_center_id": "",' >> build-configuration.json
          echo '  "is_internal_build": false,' >> build-configuration.json
          echo '  "is_appstore_build": false,' >> build-configuration.json
          echo '  "appstore_id": "0",' >> build-configuration.json
          echo '  "app_specific_url_scheme": "tgmod",' >> build-configuration.json
          echo '  "premium_iap_product_id": "",' >> build-configuration.json
          echo '  "enable_siri": false,' >> build-configuration.json
          echo '  "enable_icloud": false' >> build-configuration.json
          echo '}' >> build-configuration.json

      - name: Build Telegram
        run: |
          # First, run bazel to populate external cache, then patch it
          bazel fetch //Telegram:spm_build_app 2>&1 || true
          
          # Find and patch rules_apple in bazel cache
          BAZEL_OUTPUT=$(bazel info output_base)
          
          echo "=== Bazel output_base: $BAZEL_OUTPUT ==="
          
          # Patch provisioning_profile.bzl
          PROV_FILE="$BAZEL_OUTPUT/external/rules_apple+/apple/internal/partials/provisioning_profile.bzl"
          if [ -f "$PROV_FILE" ]; then
            echo "Patching provisioning_profile.bzl..."
            cp patches/provisioning_profile_patched.bzl "$PROV_FILE"
          fi
          
          # Patch codesigning_support.bzl - replace _validate_provisioning_profile function
          CODESIGN_FILE="$BAZEL_OUTPUT/external/rules_apple+/apple/internal/codesigning_support.bzl"
          if [ -f "$CODESIGN_FILE" ]; then
            echo "Patching codesigning_support.bzl..."
            
            # Create a Python script to patch the file
            cat > /tmp/patch_codesign.py << 'PYEOF'
import re
import sys

with open(sys.argv[1], 'r') as f:
    content = f.read()

# Replace the _validate_provisioning_profile function to not fail
old_pattern = r'def _validate_provisioning_profile\([^)]*\):.*?(?=\ndef |\Z)'
new_func = '''def _validate_provisioning_profile(
        *,
        platform_type,
        provisioning_profile,
        provisioning_profile_is_optional):
    # PATCHED: Skip provisioning profile validation for TrollStore/jailbreak builds
    return

'''

content = re.sub(old_pattern, new_func, content, flags=re.DOTALL)

with open(sys.argv[1], 'w') as f:
    f.write(content)

print("Patched successfully")
PYEOF
            
            python3 /tmp/patch_codesign.py "$CODESIGN_FILE"
            
            echo "=== Patched codesigning_support.bzl (lines 215-235) ==="
            sed -n '215,235p' "$CODESIGN_FILE"
          else
            echo "ERROR: Could not find codesigning_support.bzl"
            find "$BAZEL_OUTPUT/external" -name "codesigning_support.bzl" 2>/dev/null || true
          fi
          
          # Now build
          bazel build //Telegram:spm_build_app \
            --announce_rc \
            --features=swift.use_global_module_cache \
            --verbose_failures \
            --features=swift.skip_function_bodies_for_derived_files \
            --define=buildNumber=10001 \
            --define=telegramVersion=12.3 \
            -c opt \
            --apple_platform_type=ios \
            --ios_multi_cpus=arm64 \
            --watchos_cpus=arm64_32 \
            --features=swift.opt_uses_wmo \
            --features=swift.opt_uses_osize \
            --features=dead_strip \
            --objc_enable_binary_stripping \
            --//Telegram:disableProvisioningProfiles=True \
            2>&1 | tee build.log || echo "Build completed with warnings"
        continue-on-error: true
        timeout-minutes: 180

      - name: Show build errors
        if: always()
        run: |
          echo "=== Searching for ERROR in log ==="
          grep -i "error" build.log 2>/dev/null | grep -v "^cp" | tail -100 || true
          echo ""
          echo "=== Searching for ffmpeg errors ==="
          grep -i -A5 -B5 "ffmpeg" build.log 2>/dev/null | grep -i "error\|fail\|fatal" | head -50 || true
          echo ""
          echo "=== Last 500 lines of build log ==="
          tail -500 build.log 2>/dev/null || true

      - name: List build artifacts
        run: |
          ls -la bazel-bin/Telegram/ 2>/dev/null || echo "No artifacts"
          find bazel-bin -name "*.app" 2>/dev/null || true

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Telegram-Mod-IPA
          path: bazel-bin/Telegram/Telegram.ipa
          if-no-files-found: warn

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: telegram-mod-build
          path: bazel-bin/Telegram/*.app
          if-no-files-found: warn

      - name: Upload build log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-log
          path: build.log
          if-no-files-found: warn
