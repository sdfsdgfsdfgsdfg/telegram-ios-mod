name: Build Telegram iOS Mod (Signed)

# Этот workflow требует настройки секретов в GitHub:
# - APPLE_CERTIFICATE_BASE64: Base64 закодированный .p12 сертификат
# - APPLE_CERTIFICATE_PASSWORD: Пароль от сертификата
# - PROVISIONING_PROFILE_BASE64: Base64 закодированный .mobileprovision
# - TELEGRAM_API_ID: API ID от my.telegram.org
# - TELEGRAM_API_HASH: API Hash от my.telegram.org
# - APPLE_TEAM_ID: Team ID из Apple Developer

on:
  workflow_dispatch:
    inputs:
      build_number:
        description: 'Build number'
        required: true
        default: '10001'
      configuration:
        description: 'Build configuration'
        required: true
        default: 'release_arm64'
        type: choice
        options:
          - release_arm64
          - debug_arm64

jobs:
  build-signed:
    runs-on: macos-14
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'

    - name: Install Bazel
      run: |
        brew install bazelisk
        bazel --version

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Apple Certificate
      env:
        APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      run: |
        # Создаём временный keychain
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
        
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        
        # Импортируем сертификат
        CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
        echo -n "$APPLE_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
        
        security import $CERTIFICATE_PATH -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH
        
        # Разрешаем codesign использовать keychain
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

    - name: Install Provisioning Profile
      env:
        PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        PROFILE_PATH=~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
        echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode -o "$PROFILE_PATH"

    - name: Create build configuration
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        cat > build-configuration.json << EOF
        {
          "bundle_id": "org.telegram.Telegram-iOS-Mod",
          "api_id": "${TELEGRAM_API_ID:-0}",
          "api_hash": "${TELEGRAM_API_HASH:-}",
          "team_id": "${APPLE_TEAM_ID:-}",
          "app_center_id": "",
          "is_internal_build": false,
          "is_appstore_build": false,
          "appstore_id": "0",
          "app_specific_url_scheme": "tgmod",
          "premium_iap_product_id": "",
          "enable_siri": false,
          "enable_icloud": false
        }
        EOF

    - name: Setup codesigning directory
      run: |
        mkdir -p build-input/codesigning/certs
        mkdir -p build-input/codesigning/profiles
        
        # Копируем provisioning profile
        cp ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision \
           build-input/codesigning/profiles/ 2>/dev/null || true

    - name: Build Telegram
      run: |
        python3 build-system/Make/Make.py build \
          --configurationPath=build-configuration.json \
          --codesigningInformationPath=build-input/codesigning \
          --configuration=${{ github.event.inputs.configuration }} \
          --buildNumber=${{ github.event.inputs.build_number }} \
          --outputBuildArtifactsPath=build-output

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: Telegram-Mod-${{ github.event.inputs.build_number }}
        path: build-output/Telegram.ipa
        if-no-files-found: error

    - name: Upload dSYMs
      uses: actions/upload-artifact@v4
      with:
        name: Telegram-Mod-dSYMs-${{ github.event.inputs.build_number }}
        path: build-output/Telegram.DSYMs.zip
        if-no-files-found: warn

    - name: Cleanup keychain
      if: always()
      run: |
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db 2>/dev/null || true
